#!/usr/bin/env php
<?php

declare(strict_types=1);

const CRASH_SIGNALS = [
    SIGSEGV,
    SIGBUS,
    SIGILL,
    SIGABRT,
    SIGFPE,
    SIGTRAP,
];

const SIGNAL_LABELS = [
    SIGSEGV => 'SIGSEGV',
    SIGBUS => 'SIGBUS',
    SIGILL => 'SIGILL',
    SIGABRT => 'SIGABRT',
    SIGFPE => 'SIGFPE',
    SIGTRAP => 'SIGTRAP',
];

function usage(string $script): string
{
    return <<<USAGE
Usage:
  {$script} --php-bin /path/to/php [--php-ini /path/to/php.ini] [--ops N] [--reduce] -- <command...>

Dynamic replacements in command arguments:
  {range}            -> random integer
  {range(lo,hi)}     -> random integer between lo and hi (inclusive)
  {hrtime}           -> hrtime(true)
  {ops}              -> value provided via --ops
USAGE;
}

function render_command(array $command): string
{
    return implode(' ', array_map('escapeshellarg', $command));
}

function signal_label(int $signal): string
{
    return SIGNAL_LABELS[$signal] ?? "SIG{$signal}";
}

function signal_description(int $signal): string
{
    if (function_exists('pcntl_strsignal')) {
        $desc = pcntl_strsignal($signal);
        if (is_string($desc) && $desc !== '') {
            return $desc;
        }
    }

    return '';
}

function replace_dynamic(string $arg): string
{
    $arg = preg_replace_callback('/\{range\((\-?\d+)\s*,\s*(\-?\d+)\)\}/', static function (array $matches): string {
        $lo = (int)$matches[1];
        $hi = (int)$matches[2];
        if ($lo > $hi) {
            [$lo, $hi] = [$hi, $lo];
        }

        return (string)random_int($lo, $hi);
    }, $arg);

    $arg = preg_replace_callback('/\{range\}/', static function (): string {
        return (string)random_int(0, PHP_INT_MAX);
    }, $arg);

    $arg = preg_replace_callback('/\{hrtime\}/', static function (): string {
        return (string)hrtime(true);
    }, $arg);

    return $arg;
}

function apply_ops(string $arg, ?int $ops): string
{
    if ($ops === null) {
        return $arg;
    }

    return str_replace('{ops}', (string)$ops, $arg);
}

function format_duration(int $seconds): string
{
    $days = intdiv($seconds, 86400);
    $seconds -= $days * 86400;
    $hours = intdiv($seconds, 3600);
    $seconds -= $hours * 3600;
    $minutes = intdiv($seconds, 60);
    $seconds -= $minutes * 60;

    if ($days > 0) {
        return sprintf('%dd %02d:%02d:%02d', $days, $hours, $minutes, $seconds);
    }

    return sprintf('%02d:%02d:%02d', $hours, $minutes, $seconds);
}

function terminal_width(): int
{
    $columns = getenv('COLUMNS');
    if (is_string($columns) && ctype_digit($columns)) {
        return max(60, (int)$columns);
    }

    return 80;
}

function truncate_text(string $text, int $width): string
{
    if ($width <= 0) {
        return '';
    }

    if (strlen($text) <= $width) {
        return $text;
    }

    if ($width <= 3) {
        return substr($text, 0, $width);
    }

    return substr($text, 0, $width - 3) . '...';
}

function pad_line(string $text, int $width): string
{
    $text = truncate_text($text, $width);
    return str_pad($text, $width);
}

function two_column(string $left, string $right, int $width, int $gap = 3): string
{
    $gap = max(1, $gap);
    $leftWidth = intdiv($width - $gap, 2);
    $rightWidth = $width - $gap - $leftWidth;

    $left = str_pad(truncate_text($left, $leftWidth), $leftWidth);
    $right = str_pad(truncate_text($right, $rightWidth), $rightWidth);

    return $left . str_repeat(' ', $gap) . $right;
}

function render_screen(array $stats, ?int $currentOps, string $mode): void
{
    $width = terminal_width();
    $now = microtime(true);
    $elapsed = format_duration((int)($now - $stats['start_time']));
    $sinceFailure = $stats['last_failure_time'] !== null
        ? format_duration((int)($now - $stats['last_failure_time']))
        : 'never';

    $lines = [];
    $lines[] = str_repeat('=', $width);
    $title = 'relay-table-fuzzer harness';
    $lines[] = pad_line(str_pad($title, $width, ' ', STR_PAD_BOTH), $width);
    $lines[] = str_repeat('-', $width);
    $lines[] = two_column("Elapsed: {$elapsed}", 'Runs: ' . number_format($stats['runs']), $width);
    $lines[] = two_column('Reproducers: ' . number_format($stats['reproducers']), "Last failure: {$sinceFailure}", $width);
    $opsLabel = $currentOps !== null ? (string)$currentOps : 'n/a';
    $lines[] = two_column("Ops: {$opsLabel}", 'Reductions: ' . number_format($stats['reductions']), $width);
    $lastFailure = $stats['last_failure_summary'] !== '' ? $stats['last_failure_summary'] : 'none';
    $lines[] = two_column("Mode: {$mode}", "Last crash: {$lastFailure}", $width);
    $event = $stats['last_event'] !== '' ? $stats['last_event'] : 'none';
    $lines[] = pad_line("Event: {$event}", $width);
    $lastRepro = $stats['last_reproducer'] !== '' ? $stats['last_reproducer'] : 'n/a';
    $lines[] = pad_line("Last reproducer: {$lastRepro}", $width);
    $lines[] = str_repeat('-', $width);
    $command = $stats['last_command'] ?? '';
    $lines[] = pad_line("Command: {$command}", $width);
    $lines[] = str_repeat('=', $width);

    fwrite(STDOUT, "\033[2J\033[H" . implode("\n", $lines) . "\n");
    fflush(STDOUT);
}

function find_core_dumps(string $phpBin, ?int $pid): array
{
    if ($pid === null) {
        return [];
    }

    $binary = basename($phpBin);
    $pattern = "/tmp/core.{$binary}.{$pid}.*";
    $cores = glob($pattern);

    return $cores !== false ? $cores : [];
}

function run_command(array $fullCommand, array $descriptorSpec, string $phpBin): array
{
    $process = proc_open($fullCommand, $descriptorSpec, $pipes);
    if (!is_resource($process)) {
        fwrite(STDERR, "Failed to start process\n");
        exit(1);
    }

    $status = proc_get_status($process);
    $pid = $status['pid'] ?? null;

    while ($status['running']) {
        usleep(10000);
        $status = proc_get_status($process);
    }

    $exitCode = proc_close($process);

    $signal = null;
    if (($status['signaled'] ?? false) && isset($status['termsig'])) {
        $signal = (int)$status['termsig'];
    } elseif ($exitCode !== 0 && $exitCode > 128) {
        $signal = $exitCode - 128;
    }

    $coreFiles = find_core_dumps($phpBin, $pid);
    $isCrash = ($signal !== null && in_array($signal, CRASH_SIGNALS, true)) || $coreFiles !== [];

    return [
        'exit_code' => $exitCode,
        'signal' => $signal,
        'pid' => $pid,
        'is_crash' => $isCrash,
        'core_files' => $coreFiles,
    ];
}

function reduce_ops(
    int $maxOps,
    array $dynamicArgs,
    string $phpBin,
    ?string $phpIni,
    array $descriptorSpec,
    array &$stats,
    string $jobDir
): int {
    $low = 1;
    $high = $maxOps;

    while ($low < $high) {
        $mid = intdiv($low + $high, 2);
        $runArgs = array_map(static fn(string $arg): string => apply_ops($arg, $mid), $dynamicArgs);
        $fullCommand = array_merge([$phpBin], $phpIni !== null ? ['-c', $phpIni] : [], $runArgs);
        $commandString = render_command($fullCommand);

        $result = run_command($fullCommand, $descriptorSpec, $phpBin);
        $stats['runs']++;
        $stats['last_command'] = $commandString;
        $stats['last_event'] = "reducing ops: {$mid}";
        if ($result['is_crash']) {
            $stats['last_failure_time'] = microtime(true);
            $stats['last_failure_summary'] = build_failure_summary($result);
            $stats['last_event'] = "reducer crash at ops {$mid}";
            move_core_dumps($result['core_files'], $jobDir);
        }
        render_screen($stats, $mid, 'reducing');
        if ($result['is_crash']) {
            $high = $mid;
            continue;
        }

        $low = $mid + 1;
    }

    return $low;
}

function move_core_dumps(array $coreFiles, string $destinationDir): void
{
    foreach ($coreFiles as $coreFile) {
        $target = $destinationDir . '/' . basename($coreFile);
        if (@rename($coreFile, $target)) {
            continue;
        }

        if (@copy($coreFile, $target)) {
            @unlink($coreFile);
        }
    }
}

function build_failure_summary(array $result): string
{
    if (!empty($result['core_files'])) {
        $core = basename($result['core_files'][0]);
        return "core {$core}";
    }

    if ($result['signal'] !== null) {
        return signal_label($result['signal']);
    }

    return 'EXIT_' . $result['exit_code'];
}

$argv = $_SERVER['argv'];
$argc = $_SERVER['argc'];

$phpBin = null;
$phpIni = null;
$ops = null;
$reduce = false;
$commandArgs = [];

for ($i = 1; $i < $argc; $i++) {
    $arg = $argv[$i];
    if ($arg === '--') {
        $commandArgs = array_slice($argv, $i + 1);
        break;
    }

    if ($arg === '--help' || $arg === '-h') {
        fwrite(STDOUT, usage($argv[0]) . "\n");
        exit(0);
    }

    if ($arg === '--php-bin') {
        $phpBin = $argv[++$i] ?? null;
        continue;
    }

    if ($arg === '--php-ini') {
        $phpIni = $argv[++$i] ?? null;
        continue;
    }

    if ($arg === '--ops') {
        $ops = $argv[++$i] ?? null;
        $ops = is_numeric($ops) ? (int)$ops : null;
        continue;
    }

    if ($arg === '--reduce') {
        $reduce = true;
        continue;
    }

    fwrite(STDERR, "Unknown option: {$arg}\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

if ($phpBin === null || $phpBin === '') {
    fwrite(STDERR, "Missing required --php-bin\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

if ($commandArgs === []) {
    fwrite(STDERR, "Missing command after --\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

$usesOps = false;
foreach ($commandArgs as $arg) {
    if (strpos($arg, '{ops}') !== false) {
        $usesOps = true;
        break;
    }
}

if ($usesOps && $ops === null) {
    fwrite(STDERR, "Missing required --ops for {ops} replacement\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

if ($reduce && !$usesOps) {
    fwrite(STDERR, "--reduce requires {ops} in the command arguments\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

if ($reduce && ($ops === null || $ops <= 0)) {
    fwrite(STDERR, "--reduce requires a positive --ops value\n");
    fwrite(STDERR, usage($argv[0]) . "\n");
    exit(1);
}

$reproducersDir = __DIR__ . '/../reproducers';
if (!is_dir($reproducersDir)) {
    mkdir($reproducersDir, 0777, true);
}

$descriptorSpec = [
    0 => ['file', 'php://stdin', 'r'],
    1 => ['file', 'php://stdout', 'w'],
    2 => ['file', 'php://stderr', 'w'],
];

$currentOps = $ops;
$stats = [
    'start_time' => microtime(true),
    'runs' => 0,
    'reproducers' => 0,
    'last_failure_time' => null,
    'last_failure_summary' => '',
    'reductions' => 0,
    'last_command' => '',
    'last_event' => '',
    'last_reproducer' => '',
];

while (true) {
    $dynamicArgs = array_map('replace_dynamic', $commandArgs);
    $runArgs = array_map(static fn(string $arg): string => apply_ops($arg, $currentOps), $dynamicArgs);
    $fullCommand = array_merge([$phpBin], $phpIni !== null ? ['-c', $phpIni] : [], $runArgs);
    $commandString = render_command($fullCommand);

    $result = run_command($fullCommand, $descriptorSpec, $phpBin);
    $stats['runs']++;
    $stats['last_command'] = $commandString;
    $stats['last_event'] = 'running';
    if ($result['is_crash']) {
        $stats['last_failure_time'] = microtime(true);
        $stats['last_failure_summary'] = build_failure_summary($result);
        $stats['last_event'] = 'crash detected';
    }
    render_screen($stats, $currentOps, 'fuzzing');
    if (!$result['is_crash']) {
        continue;
    }

    $jobId = date('Ymd_His') . '_' . bin2hex(random_bytes(4));
    $jobDir = $reproducersDir . '/' . $jobId;
    mkdir($jobDir, 0777, true);

    $finalCommand = $commandString;
    $finalOps = $currentOps;

    if ($reduce && $currentOps !== null) {
        $stats['reductions']++;
        $finalOps = reduce_ops($currentOps, $dynamicArgs, $phpBin, $phpIni, $descriptorSpec, $stats, $jobDir);
        $reducedArgs = array_map(static fn(string $arg): string => apply_ops($arg, $finalOps), $dynamicArgs);
        $finalCommand = render_command(array_merge([$phpBin], $phpIni !== null ? ['-c', $phpIni] : [], $reducedArgs));

        if ($finalCommand !== $commandString) {
            file_put_contents($jobDir . '/command-original.txt', $commandString . "\n");
        }
    }

    file_put_contents($jobDir . '/command.txt', $finalCommand . "\n");

    $signal = $result['signal'];
    $exitCode = $result['exit_code'];
    $pid = $result['pid'];

    $signalLabel = $signal !== null ? signal_label($signal) : 'none';
    $signalDesc = $signal !== null ? signal_description($signal) : '';
    $exitName = $signal !== null ? $signalLabel : "EXIT_{$exitCode}";

    $report = [
        "command: {$finalCommand}",
        "exit_code: {$exitCode}",
        "exit_name: {$exitName}",
        "signal: {$signalLabel}",
    ];
    if ($finalOps !== null) {
        $report[] = "ops: {$finalOps}";
    }
    if ($signalDesc !== '') {
        $report[] = "signal_desc: {$signalDesc}";
    }
    $report[] = "pid: " . ($pid ?? 'unknown');
    if (!empty($result['core_files'])) {
        $report[] = 'core_files: ' . implode(', ', array_map('basename', $result['core_files']));
    }

    file_put_contents($jobDir . '/report.txt', implode("\n", $report) . "\n");

    move_core_dumps($result['core_files'], $jobDir);

    $stats['reproducers']++;
    $stats['last_event'] = "reproducer saved: {$jobDir}";
    $stats['last_reproducer'] = $jobDir;
    render_screen($stats, $currentOps, $reduce ? 'reducing' : 'fuzzing');

    if ($reduce && $finalOps !== null) {
        $currentOps = $finalOps;
        continue;
    }

    exit(1);
}
